@page
@model RegisterModel
@{
    ViewData["Title"] = "Registro";

    // ¿Es edición?
    var isEdit = Model.AdminMode && string.Equals(Model.Mode, "edit", StringComparison.OrdinalIgnoreCase);

    // Filtrado de roles según quién está creando/editando:
    var all = Model.AllRoles ?? new List<string>();
    var isAdmin = User?.Identity?.IsAuthenticated == true && User.IsInRole("Admin");
    var rolesForUser = isAdmin
        ? all
        : all.Where(r => !string.Equals(r, "Admin", StringComparison.OrdinalIgnoreCase)).ToList();
}

<h1 class="text-center">@ViewData["Title"]</h1>

<div class="row justify-content-center">
    <div class="col-md-5">

        <form id="registerForm" asp-route-returnUrl="@Model.ReturnUrl" method="post">
            @* Mantener el contexto de administración/edición *@
            <input type="hidden" asp-for="AdminMode" />
            <input type="hidden" asp-for="Mode" />
            <input type="hidden" asp-for="TargetUserId" />

            <h2 class="mb-3 text-center">
                @(isEdit ? "Editar usuario" : "Crear una nueva cuenta")
            </h2>

            <hr />

            <div asp-validation-summary="ModelOnly" class="text-danger" role="alert"></div>

            @* ======== DATOS DE CUENTA (IDENTITY) ======== *@
            <div class="form-floating mb-3">
                <input asp-for="Input.Email" class="form-control" autocomplete="username" aria-required="true" placeholder="correo@ejemplo.com" />
                <label asp-for="Input.Email">Correo electrónico</label>
                <span asp-validation-for="Input.Email" class="text-danger"></span>
            </div>

            @* Campos de contraseña SOLO en modo Crear *@
            @if (!isEdit)
            {
                <div class="form-floating mb-3">
                    <input asp-for="Input.Password" class="form-control" autocomplete="new-password" aria-required="true" placeholder="Contraseña" />
                    <label asp-for="Input.Password">Contraseña</label>
                    <span asp-validation-for="Input.Password" class="text-danger"></span>
                </div>

                <div class="form-floating mb-3">
                    <input asp-for="Input.ConfirmPassword" class="form-control" autocomplete="new-password" aria-required="true" placeholder="Confirmar contraseña" />
                    <label asp-for="Input.ConfirmPassword">Confirmar contraseña</label>
                    <span asp-validation-for="Input.ConfirmPassword" class="text-danger"></span>
                </div>
            }

            <!-- Nombre visible -->
            <div class="form-floating mb-3">
                <input asp-for="Input.DisplayName" class="form-control" placeholder="Nombre visible" />
                <label asp-for="Input.DisplayName">Nombre visible</label>
                <span asp-validation-for="Input.DisplayName" class="text-danger"></span>
            </div>

            @* ======== DATOS PERSONALES (COMUNES) ======== *@
            <h5 class="mt-4">Datos personales</h5>
            <hr class="mt-1 mb-3" />

            <div class="form-floating mb-3">
                <input asp-for="Input.Nombre" class="form-control" placeholder="Nombre" />
                <label asp-for="Input.Nombre"></label>
                <span asp-validation-for="Input.Nombre" class="text-danger"></span>
            </div>

            <div class="form-floating mb-3">
                <input asp-for="Input.Apellido" class="form-control" placeholder="Apellido" />
                <label asp-for="Input.Apellido"></label>
                <span asp-validation-for="Input.Apellido" class="text-danger"></span>
            </div>

            <div class="form-floating mb-3">
                <input asp-for="Input.Dni" class="form-control" placeholder="DNI" />
                <label asp-for="Input.Dni"></label>
                <span asp-validation-for="Input.Dni" class="text-danger"></span>
            </div>

            <div class="form-floating mb-3">
                <input asp-for="Input.Telefono" class="form-control" placeholder="Teléfono" />
                <label asp-for="Input.Telefono"></label>
                <span asp-validation-for="Input.Telefono" class="text-danger"></span>
            </div>

            <div class="form-floating mb-3">
                <input asp-for="Input.FechaNacimiento" class="form-control" />
                <label asp-for="Input.FechaNacimiento"></label>
                <span asp-validation-for="Input.FechaNacimiento" class="text-danger"></span>
            </div>

            @* ======== DATOS PACIENTE (SECCIÓN MOSTRABLE/OCULTABLE) ======== *@
            <div id="paciente-section" class="mt-3">
                <h5 class="mt-3">Datos de paciente</h5>
                <small class="text-muted d-block mb-2">
                    Se usan si el usuario tiene rol <strong>Paciente</strong>.
                </small>

                <div class="form-floating mb-3">
                    <select asp-for="Input.IdObraSocial"
                        asp-items="Model.ObrasSociales"
                        class="form-select">
                        <option value="">Seleccione una obra social</option>
                    </select>
                    <label asp-for="Input.IdObraSocial"></label>
                    <span asp-validation-for="Input.IdObraSocial" class="text-danger"></span>
            </div>

            </div>

            @* ======== DATOS MÉDICO (SECCIÓN MOSTRABLE/OCULTABLE) ======== *@
            <div id="medico-section" class="mt-3">
                <h5 class="mt-3">Datos de médico</h5>
                <small class="text-muted d-block mb-2">
                    Se usan si el usuario tiene rol <strong>Médico</strong>.
                </small>

                <div class="form-floating mb-3">
                    <input asp-for="Input.Matricula" class="form-control" placeholder="Matrícula" />
                    <label asp-for="Input.Matricula"></label>
                    <span asp-validation-for="Input.Matricula" class="text-danger"></span>
                </div>

                <div class="form-floating mb-3">
                    <select asp-for="Input.IdEspecialidad"
                        asp-items="Model.Especialidades"
                        class="form-select">
                        <option value="">Seleccione una especialidad</option>
                    </select>
                    <label asp-for="Input.IdEspecialidad"></label>
                    <span asp-validation-for="Input.IdEspecialidad" class="text-danger"></span>
                </div>

                <div class="form-floating mb-3">
                    <select asp-for="Input.IdConsultorio"
                        asp-items="Model.Consultorios"
                        class="form-select">
                        <option value="">Seleccione un consultorio</option>
                    </select>
                    <label asp-for="Input.IdConsultorio"></label>
                    <span asp-validation-for="Input.IdConsultorio" class="text-danger"></span>
                </div>

            </div>

            @* ======== ROLES ======== *@
            <div class="mb-3 mt-4">
                <label class="form-label fw-semibold">Roles del usuario</label>
                <select asp-for="Roles"
                        id="rolesSelect"
                        class="form-select"
                        multiple
                        size="6"
                        asp-items="@(new MultiSelectList(rolesForUser))"
                        style="max-height: 220px; overflow:auto;">
                </select>
                <small id="rolesHelp" class="text-muted d-block mt-1">
                    Usá Ctrl/⌘ + clic para seleccionar múltiples. <span id="rolesCount"></span>
                </small>
            </div>

            <button id="registerSubmit" type="submit" class="w-100 btn btn-lg btn-primary">
                @(isEdit ? "Guardar cambios" : "Registrar")
            </button>
        </form>
    </div>

    <!-- Autenticación externa -->
    <div class="col-md-6 col-md-offset-2">
        <section class="mt-4">
            <h3>Usar otro servicio para registrarse</h3>
            <hr />

            @if ((Model.ExternalLogins?.Count ?? 0) == 0)
            {
                <div>
                    <p>
                        No hay servicios de autenticación externos configurados.
                        Consultá este
                        <a href="https://go.microsoft.com/fwlink/?LinkID=532715">
                            artículo para configurar login externo en una app ASP.NET
                        </a>.
                    </p>
                </div>
            }
            else
            {
                <form id="external-account" asp-page="./ExternalLogin" asp-route-returnUrl="@Model.ReturnUrl" method="post" class="form-horizontal">
                    <p>
                        @foreach (var provider in Model.ExternalLogins!)
                        {
                            <button type="submit" class="btn btn-primary me-2 mb-2"
                                    name="provider" value="@provider.Name"
                                    title="Registrarse usando @provider.DisplayName">
                                @provider.DisplayName
                            </button>
                        }
                    </p>
                </form>
            }
        </section>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function () {
            const sel = document.getElementById('rolesSelect');
            const label = document.getElementById('rolesCount');
            const pacienteSection = document.getElementById('paciente-section');
            const medicoSection = document.getElementById('medico-section');

            function refreshUI() {
                if (!sel) return;

                const selectedValues = Array.from(sel.selectedOptions).map(o => o.value);
                const n = selectedValues.length;

                // contador de roles seleccionados
                if (label) {
                    label.textContent = n ? `(${n} seleccionado${n > 1 ? 's' : ''})` : '';
                }

                const hasPaciente = selectedValues.some(v => v.toLowerCase() === 'paciente');
                const hasMedico = selectedValues.some(v => v.toLowerCase() === 'medico');

                // Mostrar/ocultar secciones según rol
                if (pacienteSection) {
                    pacienteSection.style.display = hasPaciente ? '' : 'none';
                }
                if (medicoSection) {
                    medicoSection.style.display = hasMedico ? '' : 'none';
                }
            }

            sel?.addEventListener('change', refreshUI);
            // Llamamos al inicio para que tome el estado inicial (p.ej. en modo edición)
            refreshUI();
        })();
    </script>
}
