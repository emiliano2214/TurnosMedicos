@{
    ViewData["Title"] = "Asistente IA";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-sm" style="border-radius: 15px; border: none;">
                <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                    <h3 class="card-title text-primary"><i class="bi bi-robot"></i> Asistente Virtual</h3>
                    <p class="text-muted small">Consultas sobre turnos, reglas y bases de datos.</p>
                </div>
                <div class="card-body p-4">
                    <div id="chat-box" class="d-flex flex-column gap-3 mb-4" style="height: 500px; overflow-y: auto; scroll-behavior: smooth;">
                        <!-- Welcome Message -->
                        <div class="align-self-start p-3 bg-light rounded-3" style="max-width: 80%;">
                            <strong>IA:</strong> Hola, ¿en qué puedo ayudarte hoy?
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white border-top-0 pb-4 px-4">
                    <div class="input-group">
                        <textarea id="user-input" class="form-control" rows="1" placeholder="Escribí tu pregunta aquí..." style="border-radius: 20px; resize: none;"></textarea>
                        <button class="btn btn-primary rounded-circle ms-2" id="btn-send" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-send-fill">&gt;</i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const btnSend = document.getElementById('btn-send');
        // Inject Role Status from Server
        const IS_ADMIN = @(User.IsInRole("Admin").ToString().ToLower());

        // Load history on startup
        document.addEventListener('DOMContentLoaded', loadHistory);

        btnSend.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function loadHistory() {
            try {
                const response = await fetch('/api/ia/history');
                if (response.ok) {
                    const messages = await response.json();
                    
                    // Clear welcome message if history exists
                    if (messages && messages.length > 0) {
                        chatBox.innerHTML = ''; 
                        
                        messages.forEach(msg => {
                            if (msg.role === 'user') {
                                appendUserMessage(msg.content);
                            } else if (msg.role === 'assistant') {
                                // Reuse appendAiResponse but with minimal data
                                appendAiResponse({ 
                                    respuestaUsuario: msg.content,
                                    // Historial messages usually don't have suggested SQL or debug preserved in this simple implementation
                                    sqlSugerido: null,
                                    debug: null
                                });
                            }
                        });
                    }
                }
            } catch (error) {
                console.error("Error loading history:", error);
            }
        }

        async function sendMessage() {
            const text = userInput.value;
            if (!text.trim()) return;

            // User Message
            appendUserMessage(text);
            userInput.value = '';

            // Loading
            const loadingId = appendLoading();

            try {
                const response = await fetch('/api/ia/chat', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pregunta: text })
                });

                removeLoading(loadingId);

                if (response.ok) {
                    const data = await response.json();
                    appendAiResponse(data);
                } else {
                    appendSystemMessage("Error: " + response.statusText);
                }
            } catch (error) {
                removeLoading(loadingId);
                appendSystemMessage("Error de conexión");
                console.error(error);
            }
        }

        function appendUserMessage(text) {
            const div = document.createElement('div');
            div.className = "p-3 rounded-3 align-self-end bg-primary text-white";
            div.style.maxWidth = "80%";
            div.style.whiteSpace = "pre-wrap";
            div.innerText = text;
            chatBox.appendChild(div);
            scrollToBottom();
        }

        function appendSystemMessage(text) {
            const div = document.createElement('div');
            div.className = "p-3 rounded-3 align-self-center bg-danger text-white small";
            div.innerText = text;
            chatBox.appendChild(div);
            scrollToBottom();
        }

        function appendAiResponse(data) {
            const div = document.createElement('div');
            div.className = "align-self-start w-100"; 
            div.style.maxWidth = "90%"; // Slightly wider for tabs

            // Generate Unique ID for Tabs
            const uniqueId = "msg-" + Date.now();

            let tabsHtml = '';
            let contentHtml = '';

            // --- TAB 1: RESPUESTA (Always Visible) ---
            tabsHtml += `
                <li class="nav-item" role="presentation">
                    <button class="nav-link active py-1 px-3 small" id="tab-resp-${uniqueId}" data-bs-toggle="tab" data-bs-target="#content-resp-${uniqueId}" type="button" role="tab">
                        Respuesta
                    </button>
                </li>
            `;
            contentHtml += `
                <div class="tab-pane fade show active" id="content-resp-${uniqueId}" role="tabpanel">
                    <div class="p-3 bg-light rounded-bottom border border-top-0 text-dark" style="white-space: pre-wrap;">${formatLinks(data.respuestaUsuario)}</div>
                </div>
            `;

            // --- ADMIN TABS ---
            if (IS_ADMIN) {
                // TAB 2: ACCIONES / SQL
                if (data.sqlSugerido) {
                    tabsHtml += `
                        <li class="nav-item" role="presentation">
                            <button class="nav-link py-1 px-3 small" id="tab-sql-${uniqueId}" data-bs-toggle="tab" data-bs-target="#content-sql-${uniqueId}" type="button" role="tab">
                                Acciones / SQL
                            </button>
                        </li>
                    `;
                    contentHtml += `
                        <div class="tab-pane fade" id="content-sql-${uniqueId}" role="tabpanel">
                            <div class="p-3 bg-white rounded-bottom border border-top-0">
                                <div class="d-flex justify-content-end mb-2">
                                     <button class="btn btn-outline-primary btn-sm" onclick="copyToClipboard('${escapeHtml(data.sqlSugerido)}')">Copiar SQL</button>
                                </div>
                                <pre class="bg-dark text-warning p-3 rounded font-monospace small mb-0">${escapeHtml(data.sqlSugerido)}</pre>
                            </div>
                        </div>
                    `;
                }

                // TAB 3: DEBUG
                if (data.debug) {
                    tabsHtml += `
                        <li class="nav-item" role="presentation">
                            <button class="nav-link py-1 px-3 small" id="tab-debug-${uniqueId}" data-bs-toggle="tab" data-bs-target="#content-debug-${uniqueId}" type="button" role="tab">
                                Debug
                            </button>
                        </li>
                    `;
                    
                    const debugContent = renderDebugContent(data.debug);
                    contentHtml += `
                        <div class="tab-pane fade" id="content-debug-${uniqueId}" role="tabpanel">
                            <div class="p-3 bg-white rounded-bottom border border-top-0 small">
                                ${debugContent}
                            </div>
                        </div>
                    `;
                }
            }

            // Assemble Full HTML
            div.innerHTML = `
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white p-0 border-bottom-0">
                        <ul class="nav nav-tabs border-bottom" id="tabs-${uniqueId}" role="tablist">
                            ${tabsHtml}
                        </ul>
                    </div>
                    <div class="tab-content" id="content-${uniqueId}">
                        ${contentHtml}
                    </div>
                </div>
            `;

            chatBox.appendChild(div);
            scrollToBottom();
        }

        function renderDebugContent(debug) {
            if (!debug) return "Sin datos.";
            
            let html = '<ul class="list-unstyled mb-0">';
            
            // Metricas
            html += `<li class="mb-2"><strong>Confianza:</strong> ${debug.confianza ?? 'N/A'}</li>`;
            html += `<li class="mb-2"><strong>Retrieval:</strong> ${debug.msRetrieval ?? 0} ms | <strong>Gen:</strong> ${debug.msGeneracion ?? 0} ms</li>`;
            
            // Reglas
            if (debug.reglasAplicadas && debug.reglasAplicadas.length > 0) {
                 html += `<li class="mb-2"><strong>Reglas:</strong> <span class="badge bg-secondary">${debug.reglasAplicadas.join('</span> <span class="badge bg-secondary">')}</span></li>`;
            }

            // Docs
            html += `<li class="mb-1"><strong>Documentos (Snippet):</strong></li>`;
            if (debug.documentos && debug.documentos.length > 0) {
                html += `<div class="bg-light p-2 rounded border" style="max-height: 150px; overflow-y: auto;">`;
                debug.documentos.forEach(doc => {
                    html += `<p class="mb-1 border-bottom pb-1">${doc}</p>`;
                });
                html += `</div>`;
            } else {
                 html += `<div class="text-muted fst-italic">Ninguno</div>`;
            }

            html += '</ul>';
            return html;
        }

        function formatLinks(text) {
             if (!text) return "";
             // 1. Convert Markdown links [Text](/Path) or [Text](https://...)
             let formatted = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="fw-bold text-decoration-underline">$1</a>');

             // 2. Basic URL to link converter (fallback for raw URLs not in markdown)
             // We use a negative lookbehind (or check) to ensure it wasn't already converted
             // Simpler approach: avoid double-linking. 
             // Regex below finds http/https that are NOT preceded by href="
             formatted = formatted.replace(/(?<!href=")(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
             
             return formatted;
        }

        function escapeHtml(text) {
             if (!text) return "";
             return text
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }
        
        // Expose copy function globally
        window.copyToClipboard = function(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Optional: Toast or feedback
            });
        };

        function appendLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "align-self-start p-3 bg-light rounded-3 text-muted fst-italic";
            div.innerText = "Pensando...";
            chatBox.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
}
