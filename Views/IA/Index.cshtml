@{
    ViewData["Title"] = "Asistente IA";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-sm" style="border-radius: 15px; border: none;">
                <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
                    <h3 class="card-title text-primary"><i class="bi bi-robot"></i> Asistente Virtual</h3>
                    <p class="text-muted small">Consultas sobre turnos, reglas y bases de datos.</p>
                </div>
                <div class="card-body p-4">
                    <div id="chat-box" class="d-flex flex-column gap-3 mb-4" style="height: 500px; overflow-y: auto; scroll-behavior: smooth;">
                        <!-- Welcome Message -->
                        <div class="align-self-start p-3 bg-light rounded-3" style="max-width: 80%;">
                            <strong>IA:</strong> Hola, ¿en qué puedo ayudarte hoy?
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white border-top-0 pb-4 px-4">
                    <div class="input-group">
                        <textarea id="user-input" class="form-control" rows="1" placeholder="Escribí tu pregunta aquí..." style="border-radius: 20px; resize: none;"></textarea>
                        <button class="btn btn-primary rounded-circle ms-2" id="btn-send" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-send-fill">&gt;</i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const chatBox = document.getElementById('chat-box');
        const userInput = document.getElementById('user-input');
        const btnSend = document.getElementById('btn-send');

        btnSend.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const text = userInput.value;
            if (!text.trim()) return;

            // User Message
            appendMessage('Usuario', text, 'align-self-end bg-primary text-white');
            userInput.value = '';

            // Loading
            const loadingId = appendLoading();

            try {
                const response = await fetch('/api/ia/chat', { // Changed to new API endpoint
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pregunta: text })
                });

                removeLoading(loadingId);

                if (response.ok) {
                    const data = await response.json();
                    
                    // Render Answer
                    if (data.answer) {
                        appendMessage('IA', data.answer, 'align-self-start bg-light text-dark');
                    }

                    // Render Review (Notes)
                    if (data.notes) {
                        appendNote(data.notes);
                    }

                    // Render SQL
                    if (data.suggestedSql) {
                        appendSql(data.suggestedSql);
                    }

                } else {
                    appendMessage('Sistema', "Error: " + response.statusText, 'align-self-center bg-danger text-white small');
                }
            } catch (error) {
                removeLoading(loadingId);
                appendMessage('Sistema', "Error de conexión", 'align-self-center bg-danger text-white small');
                console.error(error);
            }
        }

        function appendMessage(sender, text, classes) {
            const div = document.createElement('div');
            div.className = `p-3 rounded-3 ${classes}`;
            div.style.maxWidth = "80%";
            div.style.whiteSpace = "pre-wrap";
            
            // Bold sender only for AI/System
            if (sender !== 'Usuario') {
                div.innerHTML = `<strong>${sender}:</strong> ${text}`;
            } else {
                div.innerText = text;
            }
            
            chatBox.appendChild(div);
            scrollToBottom();
            return div;
        }

        function appendSql(sql) {
            const div = document.createElement('div');
            div.className = "align-self-start p-3 bg-dark text-warning rounded-3 font-monospace small mb-2";
            div.style.maxWidth = "90%";
            div.style.overflowX = "auto";
            div.innerHTML = `<strong>SQL Sugerido:</strong><br><pre class="mb-0 mt-2">${sql}</pre>`;
            chatBox.appendChild(div);
            scrollToBottom();
        }

        function appendNote(note) {
             const div = document.createElement('div');
            div.className = "align-self-start p-2 bg-info bg-opacity-10 text-info rounded-3 small mb-2";
            div.style.maxWidth = "80%";
            div.innerHTML = `<i class="bi bi-info-circle"></i> <em>${note}</em>`;
            chatBox.appendChild(div);
            scrollToBottom();
        }

        function appendLoading() {
            const id = 'loading-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = "align-self-start p-3 bg-light rounded-3 text-muted fst-italic";
            div.innerText = "Pensando...";
            chatBox.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
}
